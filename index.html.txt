<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Temp Mail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; padding-top: 50px; }
        .email-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-log { font-size: 0.8rem; color: red; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="text-center mb-4">
                <h1>üöÄ Fast Temp Mail</h1>
                <button class="btn btn-sm btn-outline-danger mt-2" onclick="hardReset()">‚ö†Ô∏è Click Here if Stuck</button>
            </div>

            <div class="email-box mb-4">
                <label class="form-label fw-bold">Your Email Address:</label>
                <div class="input-group mb-3">
                    <input type="text" id="current-email" class="form-control" readonly value="Connecting..." style="font-size: 1.2rem; font-weight: bold; color: #0d6efd;">
                    <button class="btn btn-secondary" onclick="copyToClipboard()">Copy</button>
                </div>
                <div id="status-msg" class="status-log"></div>
            </div>

            <div class="email-box">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="m-0">Inbox</h4>
                    <button class="btn btn-sm btn-success" onclick="fetchMessages()">Refresh</button>
                </div>
                <div id="message-list">
                    <p class="text-center text-muted mt-3">Waiting for emails...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Switched to mail.gw (often faster/less blocked)
    const API_URL = "https://api.mail.gw";
    
    async function init() {
        log("Starting app...");
        
        // 1. Check if we already have an account
        let token = localStorage.getItem("tm_token");
        let account = localStorage.getItem("tm_account");

        if (token && account) {
            log("Restoring saved account...");
            let accData = JSON.parse(account);
            document.getElementById("current-email").value = accData.address;
            fetchMessages();
        } else {
            log("Creating new account...");
            await createRandomAccount();
        }
        
        // Start auto-refresh
        setInterval(fetchMessages, 5000);
    }

    async function createRandomAccount() {
        try {
            // Get Domains
            log("Fetching domains...");
            let domainRes = await fetch(`${API_URL}/domains`);
            if (!domainRes.ok) throw new Error("Could not connect to API");
            let domainData = await domainRes.json();
            let domain = domainData['hydra:member'][0].domain;

            // Create Account
            let user = "user" + Math.random().toString(36).substring(7);
            let address = `${user}@${domain}`;
            let password = "password";

            log("Registering " + address);
            await fetch(`${API_URL}/accounts`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ address: address, password: password })
            });

            // Get Token
            let tokenRes = await fetch(`${API_URL}/token`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ address: address, password: password })
            });
            let tokenData = await tokenRes.json();

            // Save
            localStorage.setItem("tm_token", tokenData.token);
            localStorage.setItem("tm_account", JSON.stringify({ address: address }));
            
            document.getElementById("current-email").value = address;
            log(""); // Clear errors

        } catch (e) {
            log("Error: " + e.message + ". Try clicking the Red Reset button.");
        }
    }

    async function fetchMessages() {
        let token = localStorage.getItem("tm_token");
        if (!token) return;

        try {
            let res = await fetch(`${API_URL}/messages`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            let data = await res.json();
            renderInbox(data['hydra:member']);
        } catch (e) {
            console.log("Inbox refresh failed");
        }
    }

    function renderInbox(messages) {
        let list = document.getElementById("message-list");
        if (!messages || messages.length === 0) {
            list.innerHTML = '<p class="text-center text-muted mt-3">Inbox is empty.</p>';
            return;
        }
        list.innerHTML = "";
        messages.forEach(msg => {
            let div = document.createElement("div");
            div.className = "p-2 border-bottom";
            div.innerText = `From: ${msg.from.address} - ${msg.subject}`;
            list.appendChild(div);
        });
    }

    function hardReset() {
        localStorage.clear();
        location.reload();
    }

    function copyToClipboard() {
        let copyText = document.getElementById("current-email");
        copyText.select();
        document.execCommand("copy");
    }

    function log(msg) {
        document.getElementById("status-msg").innerText = msg;
    }

    // Start
    init();
</script>

</body>
</html>